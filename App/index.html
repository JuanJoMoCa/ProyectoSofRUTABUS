<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RUTABUS - Rutas de Xalapa</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body, html { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .sidebar {
      height: 100vh; overflow-y: auto; background: #f8f9fa;
      padding: 15px; border-right: 1px solid #ddd;
    }
    .container-flex { display: flex; height: calc(100vh - 56px); }
  </style>
</head>
<body>

  <!-- Barra superior -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <img src="logo.png" alt="Logo" width="80" height="60" class="d-inline-block align-text-top me-2">
        RUTABUS
      </a>
    </div>
  </nav>

  <!-- Layout -->
  <div class="container-flex">
    <!-- Barra lateral -->
    <div class="sidebar col-3">
      <h4>Rutas disponibles</h4>
      <ul class="list-group">
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="001" data-stop="1">Ruta 1: Ávila Camacho - UV</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="002" data-stop="2">Ruta 2: Lucas Martín - Centro</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="003" data-stop="3">Ruta 3: Av. Xalapa - Lazaro Cardenas</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="004" data-stop="4">Ruta 4: Lázaro Cardenas - av.xalapa (economía)</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="005" data-stop="5">Ruta 5: Campo de Tiro - Colonia Hernández Castillo - Sayago</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="006" data-stop="6">Ruta 6: Miradores - Trancas - Tesoreria - Banderilla</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="007" data-stop="7">Ruta 7: Mercado - Pipila - Jardines - Carolino Anaya</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="008" data-stop="8">Ruta 8: Buena Vista- Sauces- Berros- Caxa- Trancas- Pradera- Central Abastos</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="009" data-stop="9">Ruta 9: Reserva Territorial- 20 de Noviembre- Economía- Avenida Xalapa</button></li>
        <li class="list-group-item"><button class="btn btn-link ruta-btn" data-ruta="010" data-stop="10">Ruta 10: Escuela Normal Veracruzana -Avenida Xalapa, Economía, Clavijero, Reserva Territorial</button></li>
      </ul>
      <p class="mt-3 text-muted">Haz clic en una ruta para mostrarla en el mapa.</p>
    </div>

    <!-- Mapa -->
    <div id="map" class="col-9"></div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const iconParada = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61205.png",
      iconSize: [20, 20]
    });

    // Inicializar mapa centrado en Xalapa
    const map = L.map('map').setView([19.5438, -96.9103], 13);

    // Capa base OSM
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
    }).addTo(map);

    // Capas activas por ruta: { ruta: Layer|null, paradas: Layer|null }
    const capas = {};

    function safeRemove(layer) {
      if (layer && map.hasLayer(layer)) {
        map.removeLayer(layer);
      }
    }

    function hasFeatures(geojson) {
      return geojson && Array.isArray(geojson.features) && geojson.features.length > 0;
    }

    async function fetchJSON(url) {
      const res = await fetch(url, { cache: "no-cache" });
      if (!res.ok) {
        // 404 u otro error → no explotar; regresamos null
        return null;
      }
      // Puede que 404 devuelva HTML; tratamos de parsear y atrapamos error
      try {
        return await res.json();
      } catch (e) {
        console.warn("Respuesta no JSON para", url);
        return null;
      }
    }

    async function mostrarRuta(numRuta, idStops) {
      // Toggle: si ya está, quitar lo que exista y salir
      if (capas[numRuta]) {
        safeRemove(capas[numRuta].ruta);
        safeRemove(capas[numRuta].paradas);
        delete capas[numRuta];
        return;
      }

      capas[numRuta] = { ruta: null, paradas: null };

      // 1) Cargar la línea
      const rutaUrl = `data/${numRuta}/route.json`;
      const geoRuta = await fetchJSON(rutaUrl);

      if (geoRuta && hasFeatures(geoRuta)) {
        const capaRuta = L.geoJSON(geoRuta, { style: { color: "green", weight: 4 } }).addTo(map);
        capas[numRuta].ruta = capaRuta;

        // fitBounds seguro
        const bounds = capaRuta.getBounds();
        if (bounds && bounds.isValid && bounds.isValid()) {
          map.fitBounds(bounds, { padding: [20, 20] });
        }
      } else {
        console.warn(`No se pudo cargar la línea de la ruta ${numRuta} (${rutaUrl}).`);
      }

      // 2) Cargar paradas (si existe archivo)
      const stopsUrl = `data/${numRuta}/route_${idStops}_stops.geojson`;
      const geoStops = await fetchJSON(stopsUrl);

      if (geoStops && hasFeatures(geoStops)) {
        const capaParadas = L.geoJSON(geoStops, {
          pointToLayer: (_, latlng) =>
            L.marker(latlng, { icon: iconParada })
              .bindPopup(`<b>Parada:</b> ${_?.properties?.name || "Sin nombre"}`)
        }).addTo(map);
        capas[numRuta].paradas = capaParadas;
      } else {
        // No hay paradas (archivo no existe o vacío) → no pasa nada
        console.info(`Sin paradas para ruta ${numRuta} o archivo ausente (${stopsUrl}).`);
      }

      // Si no se cargó nada, limpiar el registro para no dejar un toggle “muerto”
      if (!capas[numRuta].ruta && !capas[numRuta].paradas) {
        delete capas[numRuta];
        alert(`No se pudo mostrar la ruta ${numRuta}. Verifica que existan los archivos en /data/${numRuta}/`);
      }
    }

    // Eventos en botones
    document.querySelectorAll('.ruta-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const numRuta = btn.getAttribute('data-ruta');
        const idStops = btn.getAttribute('data-stop');
        mostrarRuta(numRuta, idStops);
      });
    });
  </script>

</body>
</html>
